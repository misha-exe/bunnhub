<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunhub - Sports Hub</title>
    
    <!-- Fluid Player CSS -->
    <link rel="stylesheet" href="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.css" type="text/css"/>
    <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
    <!-- Telegram Web App Script (Optional, for close logic) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg: #F0F2F5;
            --card-bg: #FFFFFF;
            --accent: #F56E0F;
            --text-main: #1C1E21;
            --text-sub: #65676B;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

        /* App-like Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: white; position: sticky; top: 0; z-index: 100;
            box-shadow: var(--shadow);
        }
        .logo { font-weight: 900; font-size: 1.4rem; letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }
        
        .icon-btn { 
            background: #eee; border: none; cursor: pointer; 
            width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
        }

        /* Age Gate */
        #age-gate {
            position: fixed; inset: 0; background: white; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }

        /* Tabs Navigation */
        .tabs-container {
            background: white; padding: 10px 20px; 
            display: flex; gap: 25px; margin-bottom: 5px;
        }
        .tab { 
            font-weight: 700; color: var(--text-sub); cursor: pointer; 
            font-size: 15px; position: relative; padding-bottom: 8px;
        }
        .tab.active { color: var(--accent); }
        .tab.active::after { 
            content: ''; position: absolute; bottom: 0; left: 0; 
            width: 100%; height: 3px; background: var(--accent); border-radius: 2px;
        }

        /* Grid System */
        .container { padding: 15px; }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .video-card { 
            background: var(--card-bg); border-radius: 16px; overflow: hidden; 
            box-shadow: var(--shadow); transition: transform 0.2s;
        }
        .video-card:active { transform: scale(0.97); }
        .thumb-container { position: relative; aspect-ratio: 16/9; background: #000; }
        .thumb-container img { width: 100%; height: 100%; object-fit: cover; }
        .duration { 
            position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); 
            color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;
        }
        .video-info { padding: 10px; }
        .video-title { font-size: 0.9rem; font-weight: 700; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Related Videos Section */
        .related-title { margin: 20px 0 15px 0; font-size: 1.1rem; font-weight: 800; }

        /* Views */
        .view { display: none; min-height: 100vh; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Admin/Form Styles */
        .admin-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        input { 
            padding: 14px; border: 1px solid #ddd; border-radius: 12px; 
            font-size: 16px; background: white; 
        }
        .btn-primary { 
            background: var(--accent); color: white; border: none; 
            padding: 14px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer;
        }

        /* Player Page Adjustments */
        .player-wrapper { width: 100%; background: #000; margin-bottom: 15px; }
        
        /* Ad Overlay */
        #ad-view {
            position: fixed; inset: 0; background: white; z-index: 5000; display: none;
        }
        #ad-frame { width: 100%; height: 100%; border: none; }
        #ad-timer-container {
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.6); color: white; padding: 10px 15px;
            border-radius: 30px; font-weight: bold; font-size: 14px; z-index: 5100;
        }
        #close-ad { background: none; border: none; color: white; cursor: pointer; font-size: 18px; }

        .back-nav { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <!-- Age Gate -->
    <div id="age-gate">
        <h1 class="logo" style="font-size: 2.5rem;">BUN<span>HUB</span></h1>
        <p style="margin: 20px 0; color: var(--text-sub);">Sports Premium Content.<br>Verify your age to continue.</p>
        <button class="btn-primary" style="width: 200px;" onclick="dismissAgeGate()">I AM 18+</button>
    </div>

    <!-- Main Header -->
    <header>
        <div class="logo" onclick="handleInternalBack()">BUN<span>HUB</span></div>
        <button class="icon-btn" onclick="navigateTo('admin-login')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <!-- Home View -->
    <main id="home-view" class="view active">
        <div class="tabs-container">
            <div class="tab active" id="tab-trending" onclick="switchTab('trending')">Trending</div>
            <div class="tab" id="tab-highlights" onclick="switchTab('highlights')">Highlights</div>
        </div>
        <div class="container">
            <div id="video-grid" class="video-grid"></div>
        </div>
    </main>

    <!-- Player View -->
    <div id="player-view" class="view">
        <div class="player-wrapper">
            <video id="main-player"></video>
        </div>
        <div class="container">
            <div class="back-nav" onclick="handleInternalBack()">✕ Close Player</div>
            <h2 id="player-title">Video Title</h2>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">
            
            <h3 class="related-title">Related Videos</h3>
            <div id="related-grid" class="video-grid"></div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="view container">
        <div class="back-nav" onclick="handleInternalBack()">← Back</div>
        <h3>Admin Access</h3>
        <div class="admin-form">
            <input type="password" id="admin-pass" placeholder="Enter Admin Password">
            <button class="btn-primary" onclick="loginAdmin()">Login</button>
        </div>
    </div>

    <!-- Admin Upload -->
    <div id="admin-upload" class="view container">
        <div class="back-nav" onclick="handleInternalBack()">← Logout</div>
        <h3>Upload Video</h3>
        <div class="admin-form">
            <input type="text" id="vid-title" placeholder="Video Title">
            <select id="vid-category" style="padding:14px; border-radius:12px; border:1px solid #ddd;">
                <option value="trending">Trending</option>
                <option value="highlights">Highlights</option>
            </select>
            <input type="file" id="vid-file" accept="video/*">
            <button class="btn-primary" onclick="handleUpload()">Upload Now</button>
            <p id="upload-status" style="text-align:center; font-size:12px;"></p>
        </div>
    </div>

    <!-- Ad Overlay -->
    <div id="ad-view">
        <div id="ad-timer-container">
            <span id="ad-timer-text">Ad ends in 5s</span>
            <button id="close-ad" style="display:none;" onclick="closeAd()">✕</button>
        </div>
        <iframe id="ad-frame"></iframe>
    </div>

    <script>
        // --- DATA ---
        let videos = [
            { id: 1, title: "Insane Goal by Haaland", duration: "0:15", thumb: "https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=400", url: "https://www.w3schools.com/html/mov_bbb.mp4", category: 'trending' },
            { id: 2, title: "Curry with the 3 Pointer", duration: "0:45", thumb: "https://images.unsplash.com/photo-1546519638-68e109498ffc?w=400", url: "https://www.w3schools.com/html/movie.mp4", category: 'trending' },
            { id: 3, title: "Formula 1 Best Starts", duration: "2:10", thumb: "https://images.unsplash.com/photo-1533130061792-64b345e4a833?w=400", url: "https://www.w3schools.com/html/mov_bbb.mp4", category: 'highlights' },
            { id: 4, title: "Tennis Match Point", duration: "1:30", thumb: "https://images.unsplash.com/photo-1595435063852-62833397368a?w=400", url: "https://www.w3schools.com/html/movie.mp4", category: 'highlights' }
        ];

        // --- STATE MANAGEMENT ---
        let currentTab = 'trending';
        let navigationStack = ['home-view'];
        let fluidInstance = null;
        let adCountdownInterval = null;
        const AD_URL = "https://rebrandlink.com/dl/420335";

        // Initialize Fluid Player
        function initFluid(url) {
            if (fluidInstance) {
                fluidInstance.destroy();
            }
            fluidInstance = fluidPlayer('main-player', {
                layoutControls: {
                    fillToContainer: true,
                    primaryColor: "#F56E0F",
                    playButtonShowing: true,
                    autoPlay: false
                }
            });
            // Update source
            const videoTag = document.getElementById('main-player');
            videoTag.src = url;
        }

        // --- NAVIGATION LOGIC ---
        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            navigationStack.push(viewId);
        }

        function handleInternalBack() {
            // If on Ad Overlay
            if (document.getElementById('ad-view').style.display === 'block') {
                const timerText = document.getElementById('ad-timer-text').innerText;
                if (timerText === "") { // Timer finished, close button active
                    closeAd();
                }
                return; // Do nothing if timer is active
            }

            if (navigationStack.length > 1) {
                navigationStack.pop(); // Remove current
                const previousView = navigationStack[navigationStack.length - 1];
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(previousView).classList.add('active');
                
                // Cleanup player if leaving player view
                if (previousView === 'home-view' && fluidInstance) {
                    fluidInstance.pause();
                }
            } else {
                // If on home-view, try to close the Mini App
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                } else {
                    console.log("Exit Mini App requested");
                }
            }
        }

        // Listen for browser back button (hardware back)
        window.onpopstate = function() {
            handleInternalBack();
        };

        // --- TAB LOGIC ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderGrid('video-grid', tab);
        }

        // --- RENDER FUNCTIONS ---
        function renderGrid(containerId, category, excludeId = null) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            
            const filtered = videos.filter(v => 
                (category ? v.category === category : true) && v.id !== excludeId
            );

            filtered.forEach(vid => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => startAdSequence(vid);
                card.innerHTML = `
                    <div class="thumb-container">
                        <img src="${vid.thumb}">
                        <div class="duration">${vid.duration}</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${vid.title}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- AD SEQUENCE ---
        function startAdSequence(vid) {
            const adView = document.getElementById('ad-view');
            const adFrame = document.getElementById('ad-frame');
            const timerText = document.getElementById('ad-timer-text');
            const closeBtn = document.getElementById('close-ad');

            adView.style.display = 'block';
            adFrame.src = AD_URL;
            closeBtn.style.display = 'none';
            
            let timeLeft = 5;
            timerText.innerText = `Ad ends in ${timeLeft}s`;

            window.pendingVideo = vid; // Temporary store

            adCountdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    timerText.innerText = `Ad ends in ${timeLeft}s`;
                } else {
                    clearInterval(adCountdownInterval);
                    timerText.innerText = "";
                    closeBtn.style.display = 'block';
                }
            }, 1000);
        }

        function closeAd() {
            clearInterval(adCountdownInterval);
            document.getElementById('ad-view').style.display = 'none';
            document.getElementById('ad-frame').src = '';
            openPlayer(window.pendingVideo);
        }

        // --- PLAYER LOGIC ---
        function openPlayer(vid) {
            document.getElementById('player-title').innerText = vid.title;
            navigateTo('player-view');
            initFluid(vid.url);
            
            // Auto play after ad
            setTimeout(() => {
                if (fluidInstance) fluidInstance.play();
            }, 500);

            // Related videos (all others)
            renderGrid('related-grid', null, vid.id);
        }

        // --- ADMIN ---
        function loginAdmin() {
            if (document.getElementById('admin-pass').value === "admin123") {
                navigateTo('admin-upload');
            } else { alert("Wrong pass"); }
        }

        function dismissAgeGate() {
            document.getElementById('age-gate').style.display = 'none';
            switchTab('trending');
        }

        async function handleUpload() {
            const title = document.getElementById('vid-title').value;
            const category = document.getElementById('vid-category').value;
            const file = document.getElementById('vid-file').files[0];
            if (!title || !file) return alert("Missing info");

            const status = document.getElementById('upload-status');
            status.innerText = "Uploading...";

            const url = URL.createObjectURL(file);
            const thumb = await generateThumb(url);

            videos.push({
                id: Date.now(),
                title: title,
                category: category,
                duration: "New",
                thumb: thumb,
                url: url
            });

            status.innerText = "Success!";
            setTimeout(() => {
                handleInternalBack(); // Back to home
                switchTab(category);
            }, 1000);
        }

        function generateThumb(videoUrl) {
            return new Promise(resolve => {
                const video = document.createElement('video');
                video.src = videoUrl;
                video.currentTime = 1;
                video.onloadeddata = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 640; canvas.height = 360;
                    canvas.getContext('2d').drawImage(video, 0, 0, 640, 360);
                    resolve(canvas.toDataURL('image/jpeg'));
                };
            });
        }
    </script>
</body>
</html>